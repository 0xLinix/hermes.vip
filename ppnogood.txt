-- ppnogood.txt
local ESP = {}
ESP.Enabled = false

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- ================= SETTINGS =================
ESP.Settings = {
    Boxes = true,
    BoxFilled = false,

    Names = true,
    Distance = true,

    HealthBars = true,
    HealthText = true,

    TeamCheck = false,
    NPCCheck = false,
    HealthCheck = true
}

ESP.Colors = {
    Enemy = Color3.fromRGB(8,122,188),
    Team = Color3.fromRGB(80,255,80),
    Health = Color3.fromRGB(80,255,80),
    Text = Color3.new(1,1,1)
}

-- ================= CACHE =================
local Cache = {}

local function New(t)
    local d = Drawing.new(t)
    d.Visible = false
    d.Thickness = 1
    d.Transparency = 1
    return d
end

local function Create(plr)
    Cache[plr] = {
        Box = New("Square"),
        BoxFill = New("Square"),
        Name = New("Text"),
        Distance = New("Text"),
        HealthBar = New("Line"),
        HealthText = New("Text")
    }

    -- Box
    Cache[plr].Box.Filled = false
    Cache[plr].BoxFill.Filled = true
    Cache[plr].BoxFill.Transparency = 0.25

    -- Text
    Cache[plr].Name.Size = 13
    Cache[plr].Name.Center = true
    Cache[plr].Name.Outline = true

    Cache[plr].Distance.Size = 12
    Cache[plr].Distance.Center = true
    Cache[plr].Distance.Outline = true

    Cache[plr].HealthText.Size = 11
    Cache[plr].HealthText.Center = true
    Cache[plr].HealthText.Outline = true
end

local function Hide(obj)
    for _,v in pairs(obj) do
        v.Visible = false
    end
end

-- ================= UPDATE =================
local function Update(plr)
    local obj = Cache[plr]
    local char = plr.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    local hrp = char and char:FindFirstChild("HumanoidRootPart")

    if not ESP.Enabled or not char or not hum or not hrp then
        Hide(obj)
        return
    end

    if ESP.Settings.HealthCheck and hum.Health <= 0 then
        Hide(obj)
        return
    end

    if ESP.Settings.TeamCheck and plr.Team == LocalPlayer.Team then
        Hide(obj)
        return
    end

    local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
    if not onScreen then
        Hide(obj)
        return
    end

    -- Stable box sizing
    local scale = 1 / (pos.Z * math.tan(math.rad(Camera.FieldOfView / 2)) * 2) * 1000
    local w, h = math.clamp(4 * scale, 25, 300), math.clamp(6 * scale, 40, 500)
    local x, y = pos.X - w / 2, pos.Y - h / 2

    -- ================= BOX =================
    if ESP.Settings.Boxes then
        obj.Box.Size = Vector2.new(w, h)
        obj.Box.Position = Vector2.new(x, y)
        obj.Box.Color = ESP.Colors.Enemy
        obj.Box.Visible = true

        obj.BoxFill.Size = obj.Box.Size
        obj.BoxFill.Position = obj.Box.Position
        obj.BoxFill.Color = ESP.Colors.Enemy
        obj.BoxFill.Visible = ESP.Settings.BoxFilled
    else
        obj.Box.Visible = false
        obj.BoxFill.Visible = false
    end

    -- ================= NAME =================
    if ESP.Settings.Names then
        obj.Name.Text = plr.Name
        obj.Name.Position = Vector2.new(pos.X, y - 15)
        obj.Name.Color = ESP.Colors.Text
        obj.Name.Visible = true
    else
        obj.Name.Visible = false
    end

    -- ================= DISTANCE =================
    if ESP.Settings.Distance then
        local dist = math.floor((hrp.Position - Camera.CFrame.Position).Magnitude)
        obj.Distance.Text = dist .. "m"
        obj.Distance.Position = Vector2.new(pos.X, y + h + 2)
        obj.Distance.Color = ESP.Colors.Text
        obj.Distance.Visible = true
    else
        obj.Distance.Visible = false
    end

    -- ================= HEALTH BAR =================
    if ESP.Settings.HealthBars then
        local hp = math.clamp(hum.Health / hum.MaxHealth, 0, 1)

        obj.HealthBar.From = Vector2.new(x - 4, y + h)
        obj.HealthBar.To = Vector2.new(x - 4, y + h - (h * hp))
        obj.HealthBar.Color = ESP.Colors.Health
        obj.HealthBar.Thickness = 2
        obj.HealthBar.Visible = true

        if ESP.Settings.HealthText then
            obj.HealthText.Text = math.floor(hp * 100) .. "%"
            obj.HealthText.Position = Vector2.new(x - 18, y + h - (h * hp))
            obj.HealthText.Color = ESP.Colors.Health
            obj.HealthText.Visible = true
        else
            obj.HealthText.Visible = false
        end
    else
        obj.HealthBar.Visible = false
        obj.HealthText.Visible = false
    end
end

-- ================= LOOP =================
function ESP:Enable()
    if self.Enabled then return end
    self.Enabled = true

    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            Create(p)
        end
    end

    Players.PlayerAdded:Connect(function(p)
        if p ~= LocalPlayer then
            Create(p)
        end
    end)

    RunService.RenderStepped:Connect(function()
        for p in pairs(Cache) do
            Update(p)
        end
    end)
end

function ESP:Disable()
    self.Enabled = false
    for _,obj in pairs(Cache) do
        Hide(obj)
    end
end

return ESP
