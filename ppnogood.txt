local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local ESP = {}

-- ================= SETTINGS =================
ESP.Settings = {
    Boxes = false,
    Names = false,
    Distance = false,
    HealthBars = false,
    Skeleton = false,
    Arrows = false,
    TeamCheck = false
}

-- ================= COLORS =================
ESP.Colors = {
    Enemy = Color3.fromRGB(255, 70, 70),
    Team = Color3.fromRGB(70, 255, 70),
    Skeleton = Color3.fromRGB(255, 255, 255),
    Health = Color3.fromRGB(0, 255, 0),
    Arrow = Color3.fromRGB(255, 255, 255)
}

ESP.Enabled = false
ESP.Objects = {}

-- ================= INTERNAL =================
local function isEnemy(plr)
    if not ESP.Settings.TeamCheck then return true end
    return plr.Team ~= LocalPlayer.Team
end

local function cleanup(plr)
    if ESP.Objects[plr] then
        for _,d in pairs(ESP.Objects[plr]) do
            d:Remove()
        end
        ESP.Objects[plr] = nil
    end
end

local function create(plr)
    ESP.Objects[plr] = {
        box = Drawing.new("Square"),
        name = Drawing.new("Text"),
        dist = Drawing.new("Text"),
        hp = Drawing.new("Line"),
        arrow = Drawing.new("Triangle")
    }

    for _,d in pairs(ESP.Objects[plr]) do
        d.Visible = false
        d.Thickness = 1
    end
end

-- ================= UPDATE LOOP =================
RunService.RenderStepped:Connect(function()
    if not ESP.Enabled then return end

    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            if not isEnemy(plr) then
                cleanup(plr)
                continue
            end

            if not ESP.Objects[plr] then
                create(plr)
            end

            local hrp = plr.Character.HumanoidRootPart
            local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
            local objs = ESP.Objects[plr]
            local color = isEnemy(plr) and ESP.Colors.Enemy or ESP.Colors.Team

            -- BOX
            objs.box.Visible = ESP.Settings.Boxes and onScreen
            objs.box.Color = color
            objs.box.Size = Vector2.new(40, 60)
            objs.box.Position = Vector2.new(pos.X - 20, pos.Y - 30)

            -- NAME
            objs.name.Visible = ESP.Settings.Names and onScreen
            objs.name.Text = plr.Name
            objs.name.Position = Vector2.new(pos.X, pos.Y - 40)
            objs.name.Color = color
            objs.name.Size = 13
            objs.name.Center = true

            -- DISTANCE
            objs.dist.Visible = ESP.Settings.Distance and onScreen
            objs.dist.Text = math.floor((hrp.Position - Camera.CFrame.Position).Magnitude).."m"
            objs.dist.Position = Vector2.new(pos.X, pos.Y + 35)
            objs.dist.Color = color
            objs.dist.Size = 12
            objs.dist.Center = true
        else
            cleanup(plr)
        end
    end
end)

-- ================= PUBLIC =================
function ESP:Enable()
    ESP.Enabled = true
end

function ESP:Disable()
    ESP.Enabled = false
    for plr in pairs(ESP.Objects) do
        cleanup(plr)
    end
end

return ESP
