local ESP = {}
ESP.Enabled = false

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")

ESP.Settings = {
    Boxes = true,
    BoxFilled = false,
    Names = true,
    Distance = true,
    HealthBars = true,

    TeamCheck = false,
    NPCCheck = false,
    HealthCheck = true
}

ESP.Colors = {
    Enemy = Color3.fromRGB((8,122,188),
    Team = Color3.fromRGB((8,122,188),
    Health = Color3.fromRGB((8,122,188)
}

local Cache = {}

-- ================= CREATE =================
local function Create(plr)
    if Cache[plr] then return end

    local h = Instance.new("Highlight")
    h.Enabled = false
    h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    h.FillTransparency = 0.7
    h.OutlineTransparency = 0
    h.Parent = game.CoreGui

    local bb = Instance.new("BillboardGui")
    bb.AlwaysOnTop = true
    bb.Size = UDim2.new(0,200,0,50)
    bb.StudsOffset = Vector3.new(0,3,0)
    bb.Enabled = false
    bb.Parent = game.CoreGui

    local txt = Instance.new("TextLabel")
    txt.Size = UDim2.fromScale(1,1)
    txt.BackgroundTransparency = 1
    txt.TextColor3 = Color3.new(1,1,1)
    txt.TextStrokeTransparency = 0
    txt.Font = Enum.Font.GothamBold
    txt.TextScaled = true
    txt.Parent = bb

    Cache[plr] = {Highlight=h, Billboard=bb, Text=txt}
end

local function Hide(obj)
    obj.Highlight.Enabled = false
    obj.Billboard.Enabled = false
end

-- ================= UPDATE =================
local function Update(plr)
    local obj = Cache[plr]
    local char = plr.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    local hrp = char and char:FindFirstChild("HumanoidRootPart")

    if not ESP.Enabled or not char or not hum or not hrp then
        Hide(obj)
        return
    end

    if ESP.Settings.HealthCheck and hum.Health <= 0 then
        Hide(obj)
        return
    end

    if ESP.Settings.TeamCheck and plr.Team == LocalPlayer.Team then
        Hide(obj)
        return
    end

    -- HIGHLIGHT
    if ESP.Settings.Boxes then
        obj.Highlight.Adornee = char
        obj.Highlight.Enabled = true
        obj.Highlight.FillColor = ESP.Colors.Enemy
        obj.Highlight.OutlineColor = ESP.Colors.Enemy
    else
        obj.Highlight.Enabled = false
    end

    -- TEXT
    if ESP.Settings.Names or ESP.Settings.Distance then
        local dist = math.floor((hrp.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude)
        obj.Text.Text =
            (ESP.Settings.Names and plr.Name or "") ..
            (ESP.Settings.Distance and ("\n"..dist.."m") or "")

        obj.Billboard.Adornee = hrp
        obj.Billboard.Enabled = true
    else
        obj.Billboard.Enabled = false
    end
end

-- ================= LOOP =================
function ESP:Enable()
    if self.Enabled then return end
    self.Enabled = true

    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then Create(p) end
    end

    Players.PlayerAdded:Connect(function(p)
        if p ~= LocalPlayer then Create(p) end
    end)

    RunService.RenderStepped:Connect(function()
        for p,obj in pairs(Cache) do
            Update(p)
        end
    end)
end

function ESP:Disable()
    self.Enabled = false
    for _,obj in pairs(Cache) do
        Hide(obj)
    end
end

return ESP
