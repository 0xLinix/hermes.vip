local ESP = {}
ESP.Enabled = false

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

-- ================= SETTINGS =================
ESP.Settings = {
    Boxes = true,
    Names = true,
    Distance = true,
    HealthBars = true,

    TeamCheck = false,
    NPCCheck = true,
    HealthCheck = true
}

ESP.Colors = {
    Enemy = Color3.fromRGB(8,122,188),
    Team = Color3.fromRGB(8,122,188),
    Health = Color3.fromRGB(8,122,188),
    NPC = Color3.fromRGB(255,170,0)
}

-- ================= CACHE =================
local Cache = {}

-- ================= UTILS =================
local function IsValidCharacter(model)
    if not model or not model:IsA("Model") then return false end
    if not model:FindFirstChildOfClass("Humanoid") then return false end
    if not model:FindFirstChild("HumanoidRootPart") then return false end
    return true
end

local function IsNPC(model)
    return IsValidCharacter(model)
        and not Players:GetPlayerFromCharacter(model)
end

-- ================= CREATE =================
local function Create(model, isNPC)
    if Cache[model] or not IsValidCharacter(model) then return end

    local h = Instance.new("Highlight")
    h.Enabled = false
    h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    h.FillTransparency = 0.7
    h.OutlineTransparency = 0
    h.Parent = game.CoreGui

    local bb = Instance.new("BillboardGui")
    bb.AlwaysOnTop = true
    bb.Size = UDim2.new(0, 220, 0, 60)
    bb.StudsOffset = Vector3.new(0, 3, 0)
    bb.Enabled = false
    bb.Parent = game.CoreGui

    local txt = Instance.new("TextLabel")
    txt.Size = UDim2.fromScale(1, 1)
    txt.BackgroundTransparency = 1
    txt.TextColor3 = Color3.new(1,1,1)
    txt.TextStrokeTransparency = 0
    txt.Font = Enum.Font.GothamBold
    txt.TextScaled = true
    txt.Parent = bb

    Cache[model] = {
        Highlight = h,
        Billboard = bb,
        Text = txt,
        NPC = isNPC
    }
end

local function Hide(obj)
    obj.Highlight.Enabled = false
    obj.Billboard.Enabled = false
end

-- ================= UPDATE =================
local function Update(model)
    local obj = Cache[model]
    if not obj then return end
    if not IsValidCharacter(model) then
        Hide(obj)
        return
    end

    local hum = model:FindFirstChildOfClass("Humanoid")
    local hrp = model:FindFirstChild("HumanoidRootPart")

    if ESP.Settings.HealthCheck and hum.Health <= 0 then
        Hide(obj)
        return
    end

    local plr = Players:GetPlayerFromCharacter(model)

    if plr and ESP.Settings.TeamCheck and LocalPlayer.Team == plr.Team then
        Hide(obj)
        return
    end

    local color = obj.NPC and ESP.Colors.NPC or ESP.Colors.Enemy

    -- HIGHLIGHT
    if ESP.Settings.Boxes then
        obj.Highlight.Adornee = model
        obj.Highlight.FillColor = color
        obj.Highlight.OutlineColor = color
        obj.Highlight.Enabled = true
    else
        obj.Highlight.Enabled = false
    end

    -- TEXT
    local lines = {}

    if ESP.Settings.Names then
        table.insert(lines, plr and plr.Name or "NPC")
    end

    if ESP.Settings.HealthBars then
        local hp = math.floor((hum.Health / hum.MaxHealth) * 100)
        table.insert(lines, "HP: "..hp.."%")
    end

    if ESP.Settings.Distance and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local dist = math.floor(
            (hrp.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
        )
        table.insert(lines, dist.."m")
    end

    if #lines > 0 then
        obj.Text.Text = table.concat(lines, "\n")
        obj.Billboard.Adornee = hrp
        obj.Billboard.Enabled = true
    else
        obj.Billboard.Enabled = false
    end
end

-- ================= ENABLE =================
function ESP:Enable()
    if self.Enabled then return end
    self.Enabled = true

    -- PLAYERS
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            Create(p.Character, false)
        end
    end

    Players.PlayerAdded:Connect(function(p)
        p.CharacterAdded:Connect(function(c)
            Create(c, false)
        end)
    end)

    -- NPCs (SAFE)
    if ESP.Settings.NPCCheck then
        Workspace.DescendantAdded:Connect(function(m)
            if IsNPC(m) then
                task.wait(0.1)
                Create(m, true)
            end
        end)
    end

    RunService.RenderStepped:Connect(function()
        for model in pairs(Cache) do
            Update(model)
        end
    end)
end

-- ================= DISABLE =================
function ESP:Disable()
    self.Enabled = false
    for _,obj in pairs(Cache) do
        Hide(obj)
    end
end

return ESP
