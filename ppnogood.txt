local ESP = {}
ESP.Enabled = false

ESP.Settings = {
    Boxes = true,
    Names = true,
    Distance = true,
    Health = true,
    Skeleton = true,
    Arrows = false
}

ESP.Colors = {
    Box = Color3.fromRGB(255,255,255),
    Name = Color3.fromRGB(255,255,255),
    Skeleton = Color3.fromRGB(255,255,255),
    Health = Color3.fromRGB(0,255,0),
    Priority = Color3.fromRGB(255,60,60)
}

ESP.Priority = {}

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local lp = Players.LocalPlayer

local drawings = {}

local function new(t)
    return Drawing.new(t)
end

function ESP:SetPriority(p)
    ESP.Priority = p or {}
end

local function remove(plr)
    if drawings[plr] then
        for _,d in pairs(drawings[plr]) do
            d:Remove()
        end
        drawings[plr] = nil
    end
end

local function setup(plr)
    if plr == lp then return end

    drawings[plr] = {
        Box = new("Square"),
        Name = new("Text"),
        Distance = new("Text"),
        Health = new("Line")
    }

    for _,d in pairs(drawings[plr]) do
        d.Visible = false
        if d.Thickness then d.Thickness = 1 end
        if d.Size then d.Size = 13 end
        d.Center = true
        d.Outline = true
    end
end

local function update(plr)
    local char = plr.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not (char and hum and hrp) then
        remove(plr)
        return
    end

    local pos, on = Camera:WorldToViewportPoint(hrp.Position)
    if not on then
        for _,d in pairs(drawings[plr]) do d.Visible = false end
        return
    end

    local dist = math.floor((lp.Character.HumanoidRootPart.Position - hrp.Position).Magnitude)
    local scale = math.clamp(300 / pos.Z, 2, 6)

    local isPriority = ESP.Priority[plr.UserId]
    local boxColor = isPriority and ESP.Colors.Priority or ESP.Colors.Box

    -- BOX
    if ESP.Settings.Boxes then
        local b = drawings[plr].Box
        b.Visible = true
        b.Color = boxColor
        b.Size = Vector2.new(40*scale, 60*scale)
        b.Position = Vector2.new(pos.X - b.Size.X/2, pos.Y - b.Size.Y/2)
    else
        drawings[plr].Box.Visible = false
    end

    -- NAME
    if ESP.Settings.Names then
        local n = drawings[plr].Name
        n.Visible = true
        n.Text = plr.Name
        n.Color = ESP.Colors.Name
        n.Position = Vector2.new(pos.X, pos.Y - 40*scale)
    else
        drawings[plr].Name.Visible = false
    end

    -- DISTANCE
    if ESP.Settings.Distance then
        local d = drawings[plr].Distance
        d.Visible = true
        d.Text = dist.."m"
        d.Color = ESP.Colors.Name
        d.Position = Vector2.new(pos.X, pos.Y + 35*scale)
    else
        drawings[plr].Distance.Visible = false
    end

    -- HEALTH BAR
    if ESP.Settings.Health then
        local h = drawings[plr].Health
        local hp = hum.Health / hum.MaxHealth
        h.Visible = true
        h.Color = ESP.Colors.Health
        h.From = Vector2.new(pos.X - 25*scale, pos.Y + 30*scale)
        h.To = Vector2.new(h.From.X + (50*scale * hp), h.From.Y)
    else
        drawings[plr].Health.Visible = false
    end
end

function ESP:Enable()
    if ESP.Enabled then return end
    ESP.Enabled = true

    for _,p in pairs(Players:GetPlayers()) do setup(p) end
    Players.PlayerAdded:Connect(setup)
    Players.PlayerRemoving:Connect(remove)

    RunService.RenderStepped:Connect(function()
        if not ESP.Enabled then return end
        for _,p in pairs(Players:GetPlayers()) do
            if drawings[p] then update(p) end
        end
    end)
end

function ESP:Disable()
    ESP.Enabled = false
    for p in pairs(drawings) do remove(p) end
end

return ESP
