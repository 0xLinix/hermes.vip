local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local ESP = {}

-- ================= SETTINGS =================
ESP.Settings = {
    Enabled = false,

    Boxes = true,
    BoxFilled = false,
    Names = true,
    Distance = true,
    HealthBars = true,
    Skeleton = true,
    Snaplines = true,

    TeamCheck = true,
    NPCCheck = true,
    HealthCheck = true,

    Mode3D = false -- false = 2D (Drawing), true = 3D (Highlight)
}

-- ================= COLORS =================
ESP.Colors = {
    Enemy = Color3.fromRGB(255, 80, 80),
    Team = Color3.fromRGB(80, 255, 80),
    Skeleton = Color3.fromRGB(255, 255, 255),
    Health = Color3.fromRGB(0, 255, 0),
    Snapline = Color3.fromRGB(255, 255, 255)
}

-- ================= INTERNAL =================
ESP.Cache = {}

local function isValid(model)
    local hum = model:FindFirstChildOfClass("Humanoid")
    local hrp = model:FindFirstChild("HumanoidRootPart")
    if not hum or not hrp then return false end
    if ESP.Settings.HealthCheck and hum.Health <= 0 then return false end
    return true
end

local function isNPC(model)
    return Players:GetPlayerFromCharacter(model) == nil
end

local function isEnemy(player)
    if not ESP.Settings.TeamCheck then return true end
    return player.Team ~= LocalPlayer.Team
end

-- ================= DRAW CREATE =================
local function createDrawings(model)
    ESP.Cache[model] = {
        Box = Drawing.new("Square"),
        Name = Drawing.new("Text"),
        Distance = Drawing.new("Text"),
        Health = Drawing.new("Line"),
        Snapline = Drawing.new("Line"),
        Skeleton = {}
    }

    for _,d in pairs(ESP.Cache[model]) do
        if typeof(d) == "table" then continue end
        d.Visible = false
        d.Thickness = 1
    end
end

local function removeDrawings(model)
    if ESP.Cache[model] then
        for _,d in pairs(ESP.Cache[model]) do
            if typeof(d) == "table" then
                for _,l in pairs(d) do l:Remove() end
            else
                d:Remove()
            end
        end
        ESP.Cache[model] = nil
    end
end

-- ================= UPDATE LOOP =================
RunService.RenderStepped:Connect(function()
    if not ESP.Settings.Enabled then return end

    for _,model in ipairs(workspace:GetChildren()) do
        if model:IsA("Model") and isValid(model) then
            local hrp = model.HumanoidRootPart
            local hum = model:FindFirstChildOfClass("Humanoid")
            local player = Players:GetPlayerFromCharacter(model)

            if player == LocalPlayer then continue end
            if ESP.Settings.NPCCheck and player == nil then continue end
            if player and not isEnemy(player) then continue end

            if not ESP.Cache[model] then
                createDrawings(model)
            end

            local pos, onscreen = Camera:WorldToViewportPoint(hrp.Position)
            local drawings = ESP.Cache[model]
            local color = player and ESP.Colors.Enemy or ESP.Colors.Team

            if not onscreen then
                for _,d in pairs(drawings) do
                    if typeof(d) ~= "table" then d.Visible = false end
                end
                continue
            end

            local scale = math.clamp(2000 / (Camera.CFrame.Position - hrp.Position).Magnitude, 20, 100)
            local width, height = scale * 0.6, scale

            -- BOX
            drawings.Box.Visible = ESP.Settings.Boxes
            drawings.Box.Filled = ESP.Settings.BoxFilled
            drawings.Box.Size = Vector2.new(width, height)
            drawings.Box.Position = Vector2.new(pos.X - width/2, pos.Y - height/2)
            drawings.Box.Color = color

            -- NAME (above head)
            local head = model:FindFirstChild("Head")
            if head then
                local hpos = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
                drawings.Name.Visible = ESP.Settings.Names
                drawings.Name.Text = player and player.Name or "NPC"
                drawings.Name.Position = Vector2.new(hpos.X, hpos.Y - 15)
                drawings.Name.Center = true
                drawings.Name.Size = 13
                drawings.Name.Color = color
            end

            -- DISTANCE
            drawings.Distance.Visible = ESP.Settings.Distance
            drawings.Distance.Text = math.floor((Camera.CFrame.Position - hrp.Position).Magnitude).."m"
            drawings.Distance.Position = Vector2.new(pos.X, pos.Y + height/2 + 2)
            drawings.Distance.Center = true
            drawings.Distance.Size = 12
            drawings.Distance.Color = color

            -- HEALTH BAR
            drawings.Health.Visible = ESP.Settings.HealthBars
            local hpPerc = hum.Health / hum.MaxHealth
            drawings.Health.From = Vector2.new(pos.X - width/2 - 4, pos.Y + height/2)
            drawings.Health.To = Vector2.new(pos.X - width/2 - 4, pos.Y + height/2 - (height * hpPerc))
            drawings.Health.Color = ESP.Colors.Health
            drawings.Health.Thickness = 2

            -- SNAPLINE
            drawings.Snapline.Visible = ESP.Settings.Snaplines
            drawings.Snapline.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
            drawings.Snapline.To = Vector2.new(pos.X, pos.Y)
            drawings.Snapline.Color = ESP.Colors.Snapline
        end
    end
end)

-- ================= PUBLIC =================
function ESP:Enable()
    ESP.Settings.Enabled = true
end

function ESP:Disable()
    ESP.Settings.Enabled = false
    for model in pairs(ESP.Cache) do
        removeDrawings(model)
    end
end

return ESP
